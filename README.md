# Описание

Тестовое задание для компании "Эм Си Арт". Проект включает в себя Rest API сервис, сервис для отслеживания изменений с помощью `pg-notify` и публикации сообщений в `RabbitMQ`, сервис для получения сообщений из очереди и их передачи через `Socket.io`, а также сервис для удаления неиспользуемых файлов.

# Мотивация

## Использование RabbitMQ

Цель использования очереди — предотвращение потери данных при нестабильном соединении клиента. После установления соединения через сокеты для пользователя и его текущей сессии создается индивидуальная очередь сообщений. При поступлении сообщения в такую очередь осуществляется попытка его отправки с использованием `Socket.io`. Для удаления сообщения из очереди пользователь должен подтвердить его получение с помощью `acknowledgement` механизма `Socket.io`.
Такой подход позволяет гарантировать доставку данных, хотя не исключает дублирования сообщений.

## Сервис удаления неиспользуемых файлов

Консистентность данных в БД имеет приоритет над консистентностью файловой системы. Например, запись о файле может быть удалена из базы данных, но сам файл останется в директории. "Сборщик мусора" помогает решить эту проблему, периодически удаляя файлы, отсутствующие в базе данных, из директорий.

# Установка

- Установите `PostgreSQL`, создайте новую схему и выполните скрипт для создания триггера из файла **sql/tasks-triggers.pgsql**.
- Установите `RabbitMQ`. Наиболее предпочтительный вариант — использование Docker-контейнера и скрипта из папки **scripts**. Запустите **./run-rabbitmq-service.sh -c start**; сервис будет использовать конфигурацию из файла `config/dev.env`.
- Настройте конфигурацию в файле `config/dev.env`.
- Выполните `npm install` в корне проекта.
- Примените миграцию БД командой `npm run prisma-push:dev`.

# Запуск

- REST API сервис: `npm run server-api:serve-dev`.
- Сервис публикации в очередь: `npm run queue-publish-service:serve-dev`.
- Сервис взаимодействия по сокетам: `npm run queue-socket-service:serve-dev`.
- Сервис удаления файлов: `npm run attached-clean-service:serve-dev`.

# Описание сервисов

## REST API сервис

Находится в директории `apps/real-time-to-do-api`. Swagger-документация доступна по адресу `/swagger`. Сервис предоставляет REST-запросы для взаимодействия с пользователями, задачами и файлами.

## Сервис публикации сообщений

Находится в директории `apps/real-time-queue-publish-service`. Отслеживает изменения в базе данных с помощью `pg-notify`, формирует сообщения и публикует их в `RabbitMQ`. Точка входа — **pg-notify.controller.ts**.

## Сервис взаимодействия по сокетам

Находится в директории `apps/real-time-queue-socket-service`. Принимает подключения через сокеты, создает очередь сообщений для прослушивания и отправки. Точка входа — **socket.gateway.ts**.

## Сервис удаления файлов

Находится в директории `apps/real-time-attached-clean-service`. Микросервис, основанный на [NestJS Schedule](https://docs.nestjs.com/techniques/task-scheduling) периодически проверяет файловую систему на наличие потерянных файлов и удаляет их. Точка входа — **clean-service-transport.strategy.ts**.
